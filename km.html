<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iOSé£æ ¼å¡å¯†éªŒè¯ç³»ç»Ÿ</title>
    <style>
        /* æ ·å¼ä¿æŒä¸å˜ï¼Œè¿™é‡Œçœç•¥ä»¥èŠ‚çœç©ºé—´ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        
        body {
            background-color: #f2f2f7;
            color: #000;
            padding-top: 120px;
            padding-bottom: 40px;
            min-height: 100vh;
        }
        
        .dynamic-island {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 140px;
            height: 40px;
            background-color: #000;
            border-radius: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            font-weight: 500;
            z-index: 1000;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            overflow: hidden;
        }
        
        .dynamic-island:hover {
            width: 160px;
        }
        
        .dynamic-island.expanded {
            width: 340px;
            height: 500px;
            border-radius: 24px;
            padding: 20px;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .time-display {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .debug-panel {
            display: none;
            width: 100%;
            height: 100%;
            overflow-y: auto;
        }
        
        .dynamic-island.expanded .debug-panel {
            display: block;
        }
        
        .dynamic-island.expanded .time-display {
            display: none;
        }
        
        .debug-header {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .debug-content {
            background-color: #1c1c1e;
            border-radius: 12px;
            padding: 12px;
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            color: #fff;
            height: 380px;
            overflow-y: auto;
            margin-bottom: 10px;
        }
        
        .debug-controls {
            display: flex;
            gap: 10px;
        }
        
        .debug-btn {
            background-color: #007aff;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 12px;
            cursor: pointer;
            flex: 1;
        }
        
        .ios-card {
            background-color: white;
            border-radius: 16px;
            padding: 20px;
            margin: 0 20px 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        
        .card-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .input-group {
            margin-bottom: 16px;
        }
        
        .input-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 6px;
            color: #3c3c43;
        }
        
        .ios-input {
            width: 100%;
            padding: 12px 16px;
            border-radius: 12px;
            border: 1px solid #c6c6c8;
            font-size: 16px;
            background-color: #f2f2f7;
            transition: border-color 0.2s;
        }
        
        .ios-input:focus {
            outline: none;
            border-color: #007aff;
        }
        
        .ios-button {
            background-color: #007aff;
            color: white;
            border: none;
            border-radius: 12px;
            padding: 14px 20px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: background-color 0.2s;
        }
        
        .ios-button:hover {
            background-color: #0056cc;
        }
        
        .ios-button.secondary {
            background-color: #e5e5ea;
            color: #000;
        }
        
        .ios-button.secondary:hover {
            background-color: #d1d1d6;
        }
        
        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }
        
        .result-area {
            margin-top: 20px;
            padding: 16px;
            border-radius: 12px;
            background-color: #f2f2f7;
            display: none;
        }
        
        .result-success {
            background-color: #d4f7d4;
            color: #1f7a1f;
            display: block;
        }
        
        .result-error {
            background-color: #ffd6d6;
            color: #c41e1e;
            display: block;
        }
        
        .result-warning {
            background-color: #fff3cd;
            color: #856404;
            display: block;
        }
        
        .result-info {
            background-color: #cce7ff;
            color: #004085;
            display: block;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid #c6c6c8;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            font-weight: 500;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            border-bottom-color: #007aff;
            color: #007aff;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .code-editor {
            width: 100%;
            height: 200px;
            background-color: #1c1c1e;
            color: white;
            border-radius: 8px;
            padding: 12px;
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            resize: vertical;
            border: none;
        }
        
        .link-converter {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
        }
        
        .link-converter input {
            flex: 1;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-online {
            background-color: #34c759;
        }
        
        .status-offline {
            background-color: #ff3b30;
        }
        
        .status-processing {
            background-color: #ffcc00;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .log-area {
            background-color: #1c1c1e;
            color: white;
            border-radius: 12px;
            padding: 16px;
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            height: 200px;
            overflow-y: auto;
            margin-top: 20px;
            display: none;
        }
        
        .log-entry {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #2c2c2e;
        }
        
        .log-time {
            color: #8e8e93;
        }
        
        .log-level-info { color: #64d2ff; }
        .log-level-success { color: #30d158; }
        .log-level-warning { color: #ffd60a; }
        .log-level-error { color: #ff453a; }
        .log-level-debug { color: #bf5af2; }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007aff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .cors-warning {
            background-color: #fff3cd;
            color: #856404;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .unbind-btn {
            background-color: #ff3b30;
            color: white;
            border: none;
            border-radius: 12px;
            padding: 14px 20px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: background-color 0.2s;
            margin-top: 10px;
        }
        
        .unbind-btn:hover {
            background-color: #d70015;
        }
        
        .unbind-btn:disabled {
            background-color: #8e8e93;
            cursor: not-allowed;
        }
        
        .countdown-timer {
            background-color: #1c1c1e;
            color: #ffcc00;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <!-- çµåŠ¨å²› -->
    <div class="dynamic-island" id="dynamicIsland">
        <div class="time-display">
            <span id="currentTime">--:--:--</span>
        </div>
        <div class="debug-panel">
            <div class="debug-header">
                <span>å¼€å‘è€…å·¥å…·</span>
                <span class="status-indicator status-online" id="debugStatus"></span>
            </div>
            <div class="debug-content" id="debugContent">
                <!-- è°ƒè¯•ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
            <div class="debug-controls">
                <button class="debug-btn" onclick="clearDebug()">æ¸…ç©º</button>
                <button class="debug-btn" onclick="toggleAutoRepair()">è‡ªåŠ¨ä¿®å¤: å…³</button>
                <button class="debug-btn" onclick="exportLogs()">å¯¼å‡ºæ—¥å¿—</button>
            </div>
        </div>
    </div>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <div class="ios-card">
        <div class="card-title">
            <i>ğŸ”</i> å¾®éªŒå¡å¯†éªŒè¯ç³»ç»Ÿ
        </div>
        
        <!-- CORSè­¦å‘Š -->
        <div class="cors-warning">
            <strong>æ³¨æ„:</strong> ç”±äºæµè§ˆå™¨å®‰å…¨é™åˆ¶ï¼Œç›´æ¥è¯·æ±‚å¯èƒ½ä¼šå¤±è´¥ã€‚å»ºè®®ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•ï¼š
            <br>1. ä½¿ç”¨æµè§ˆå™¨æ‰©å±•ç¦ç”¨CORS
            <br>2. æˆ–ä½¿ç”¨ä»£ç†æœåŠ¡å™¨
        </div>
        
        <!-- æ ‡ç­¾é¡µ -->
        <div class="tabs">
            <div class="tab active" data-tab="verify">å¡å¯†éªŒè¯</div>
            <div class="tab" data-tab="link-convert">é“¾æ¥è½¬æ¢</div>
            <div class="tab" data-tab="developer">å¼€å‘è€…æ¨¡å¼</div>
        </div>
        
        <!-- å¡å¯†éªŒè¯æ ‡ç­¾é¡µ -->
        <div class="tab-content active" id="verify-tab">
            <div class="input-group">
                <label class="input-label">å¡å¯†</label>
                <input type="text" class="ios-input" id="cardKey" placeholder="è¯·è¾“å…¥å¡å¯†">
            </div>
            
            <div class="input-group">
                <label class="input-label">API ç«¯ç‚¹</label>
                <input type="text" class="ios-input" id="apiEndpoint" value="https://llua.cn/ajax.php?act=inspect&app=39145">
            </div>
            
            <div class="input-group">
                <label class="input-label">ä¼šè¯ Cookie (PHPSESSID)</label>
                <input type="text" class="ios-input" id="sessionCookie" placeholder="è¾“å…¥PHPSESSID (å¯é€‰)">
            </div>
            
            <div class="button-group">
                <button class="ios-button" onclick="verifyCard()" id="verifyBtn">éªŒè¯å¡å¯†</button>
                <button class="ios-button secondary" onclick="clearInputs()">æ¸…ç©º</button>
            </div>
            
            <div id="resultArea" class="result-area"></div>
            
            <!-- è§£ç»‘æŒ‰é’®åŒºåŸŸ -->
            <div id="unbindArea" style="display: none;">
                <button class="unbind-btn" onclick="unbindCard()" id="unbindBtn">è§£ç»‘å¡å¯†</button>
                <div id="countdownArea" class="countdown-timer" style="display: none;"></div>
            </div>
            
            <div class="log-area" id="logArea"></div>
            
            <div class="button-group">
                <button class="ios-button secondary" onclick="toggleLogs()">æ˜¾ç¤º/éšè—æ—¥å¿—</button>
                <button class="ios-button secondary" onclick="testLocalRequest()">æµ‹è¯•æœ¬åœ°è¯·æ±‚</button>
            </div>
        </div>
        
        <!-- é“¾æ¥è½¬æ¢æ ‡ç­¾é¡µ -->
        <div class="tab-content" id="link-convert-tab">
            <div class="input-group">
                <label class="input-label">åŸå§‹é“¾æ¥</label>
                <div class="link-converter">
                    <input type="text" class="ios-input" id="originalLink" placeholder="è¾“å…¥éœ€è¦è½¬æ¢çš„é“¾æ¥">
                    <button class="ios-button" onclick="analyzeAndConvert()">åˆ†æè½¬æ¢</button>
                </div>
            </div>
            
            <div class="input-group">
                <label class="input-label">è½¬æ¢ç»“æœ</label>
                <input type="text" class="ios-input" id="convertedLink" readonly>
            </div>
            
            <div class="input-group">
                <label class="input-label">è§£æä¿¡æ¯</label>
                <div id="parseInfo" class="result-area result-info">
                    <!-- è§£æä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
            
            <div class="button-group">
                <button class="ios-button secondary" onclick="useConvertedLink()">ä½¿ç”¨æ­¤é“¾æ¥</button>
                <button class="ios-button secondary" onclick="copyConvertedLink()">å¤åˆ¶é“¾æ¥</button>
            </div>
        </div>
        
        <!-- å¼€å‘è€…æ¨¡å¼æ ‡ç­¾é¡µ -->
        <div class="tab-content" id="developer-tab">
            <div class="input-group">
                <label class="input-label">è‡ªå®šä¹‰ä»£ç </label>
                <textarea class="code-editor" id="customCode" placeholder="// åœ¨è¿™é‡Œè¾“å…¥è‡ªå®šä¹‰JavaScriptä»£ç &#10;// ä¾‹å¦‚: console.log('Hello World');&#10;// å¯ä»¥ä½¿ç”¨ cardKey, apiEndpoint ç­‰å˜é‡"></textarea>
            </div>
            
            <div class="button-group">
                <button class="ios-button" onclick="executeCustomCode()">æ‰§è¡Œä»£ç </button>
                <button class="ios-button secondary" onclick="saveCustomCode()">ä¿å­˜ä»£ç </button>
                <button class="ios-button secondary" onclick="loadCustomCode()">åŠ è½½ä»£ç </button>
            </div>
            
            <div class="input-group">
                <label class="input-label">æ‰§è¡Œç»“æœ</label>
                <div id="customCodeResult" class="result-area">
                    <!-- è‡ªå®šä¹‰ä»£ç æ‰§è¡Œç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let debugMode = false;
        let autoRepairEnabled = false;
        let logs = [];
        let customCodeStorage = {};
        let countdownInterval = null;
        let currentCardKey = '';
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateTime();
            setInterval(updateTime, 1000);
            
            // æ ‡ç­¾é¡µåˆ‡æ¢
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    this.classList.add('active');
                    document.getElementById(this.dataset.tab + '-tab').classList.add('active');
                });
            });
            
            // çµåŠ¨å²›ç‚¹å‡»äº‹ä»¶
            document.getElementById('dynamicIsland').addEventListener('click', function() {
                this.classList.toggle('expanded');
            });
            
            // åŠ è½½ä¿å­˜çš„è‡ªå®šä¹‰ä»£ç 
            loadSavedCustomCode();
        });
        
        // æ›´æ–°æ—¶é—´æ˜¾ç¤º
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('zh-CN', { hour12: false });
            document.getElementById('currentTime').textContent = timeString;
        }
        
        // éªŒè¯å¡å¯† - ä½¿ç”¨å¾®éªŒAPI
        async function verifyCard() {
            const cardKey = document.getElementById('cardKey').value;
            const apiEndpoint = document.getElementById('apiEndpoint').value;
            const sessionCookie = document.getElementById('sessionCookie').value;
            
            if (!cardKey) {
                showResult('é”™è¯¯: å¡å¯†ä¸èƒ½ä¸ºç©º', 'error');
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const verifyBtn = document.getElementById('verifyBtn');
            const originalText = verifyBtn.textContent;
            verifyBtn.innerHTML = '<div class="loading"></div> éªŒè¯ä¸­...';
            verifyBtn.disabled = true;
            
            // éšè—è§£ç»‘åŒºåŸŸ
            document.getElementById('unbindArea').style.display = 'none';
            
            showResult('ç³»ç»Ÿå¤„ç†ä¸­ï¼Œè¯·ç¨å€™...', 'info');
            addLog('INFO', `å¼€å§‹éªŒè¯å¡å¯†: ${cardKey}`);
            addDebugInfo(`å¼€å§‹éªŒè¯å¡å¯†: ${cardKey}`);
            addDebugInfo(`APIç«¯ç‚¹: ${apiEndpoint}`);
            
            try {
                // ä½¿ç”¨å¾®éªŒAPIæ ¼å¼
                const response = await makeWeiyanRequest(apiEndpoint, cardKey, sessionCookie);
                addDebugInfo(`APIå“åº”: ${JSON.stringify(response)}`);
                
                // è§£æå“åº”
                parseWeiyanResponse(response, cardKey);
                
            } catch (error) {
                showResult(`è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
                addLog('ERROR', `è¯·æ±‚å¤±è´¥: ${error.message}`);
                addDebugInfo(`è¯·æ±‚é”™è¯¯: ${error.message}`);
                
                // æä¾›è§£å†³æ–¹æ¡ˆ
                showResult(`è¯·æ±‚å¤±è´¥: ${error.message}<br><br>
                    <strong>è§£å†³æ–¹æ¡ˆ:</strong><br>
                    1. ä½¿ç”¨æµè§ˆå™¨æ‰©å±•ç¦ç”¨CORS<br>
                    2. æˆ–ä½¿ç”¨ä»£ç†æœåŠ¡å™¨<br>
                    3. ç‚¹å‡»"æµ‹è¯•æœ¬åœ°è¯·æ±‚"æŒ‰é’®`, 'error');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                verifyBtn.textContent = originalText;
                verifyBtn.disabled = false;
            }
        }
        
        // ä½¿ç”¨å¾®éªŒAPIæ ¼å¼å‘é€è¯·æ±‚
        function makeWeiyanRequest(url, cardKey, sessionCookie) {
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                const params = `kami=${encodeURIComponent(cardKey)}`;
                
                xhr.open('POST', url, true);
                // è®¾ç½®è¯·æ±‚å¤´
                xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                xhr.setRequestHeader('User-Agent', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36');
                xhr.setRequestHeader('Referer', 'https://llua.cn/');
                xhr.setRequestHeader('Origin', 'https://llua.cn');
                
                if (sessionCookie) {
                    xhr.setRequestHeader('Cookie', `PHPSESSID=${sessionCookie}`);
                }
                
                xhr.timeout = 15000; // 15ç§’è¶…æ—¶
                
                xhr.onload = function() {
                    if (xhr.status === 200) {
                        try {
                            const response = JSON.parse(xhr.responseText);
                            resolve(response);
                        } catch (e) {
                            reject(new Error('å“åº”æ ¼å¼é”™è¯¯ï¼Œæ— æ³•è§£æJSON'));
                        }
                    } else {
                        reject(new Error(`HTTP ${xhr.status}: ${xhr.statusText}`));
                    }
                };
                
                xhr.onerror = function() {
                    reject(new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œå¯èƒ½æ˜¯CORSé™åˆ¶'));
                };
                
                xhr.ontimeout = function() {
                    reject(new Error('è¯·æ±‚è¶…æ—¶'));
                };
                
                try {
                    xhr.send(params);
                } catch (error) {
                    reject(error);
                }
            });
        }
        
        // è§£æå¾®éªŒAPIå“åº”
        function parseWeiyanResponse(response, cardKey) {
            const code = response.code;
            const msg = response.msg;
            const dismissset = response.dismissset;
            
            currentCardKey = cardKey;
            
            addLog('INFO', `å¡å¯†éªŒè¯ç»“æœ - å¡å¯†: ${cardKey}, ä»£ç : ${code}, æ¶ˆæ¯: ${msg}`);
            
            // æ˜¾ç¤ºæ¸…ç†åçš„æ¶ˆæ¯
            let resultHtml = `<strong>éªŒè¯ç»“æœ</strong><br>å¡å¯†: ${cardKey}<br><br>`;
            resultHtml += `<strong>å¤„ç†ç»“æœ:</strong><br>`;
            
            if (msg) {
                msg.split('<br>').forEach(line => {
                    if (line.trim()) {
                        resultHtml += `â€¢ ${line}<br>`;
                    }
                });
            }
            
            // æ˜¾ç¤ºæ•´ä½“çŠ¶æ€
            switch (code) {
                case 0:
                    resultHtml += `<br><strong>éªŒè¯çŠ¶æ€:</strong> å¤„ç†æˆåŠŸ`;
                    showResult(resultHtml, 'success');
                    
                    // å¦‚æœæ”¯æŒè§£ç»‘ï¼Œæ˜¾ç¤ºè§£ç»‘æŒ‰é’®
                    if (dismissset === "y") {
                        document.getElementById('unbindArea').style.display = 'block';
                        document.getElementById('unbindBtn').disabled = false;
                        document.getElementById('countdownArea').style.display = 'none';
                    }
                    break;
                case 1:
                    resultHtml += `<br><strong>éªŒè¯çŠ¶æ€:</strong> æŠ±æ­‰å¤±è´¥`;
                    showResult(resultHtml, 'error');
                    break;
                case -1:
                    resultHtml += `<br><strong>éªŒè¯çŠ¶æ€:</strong> éªŒè¯å¤±è´¥`;
                    showResult(resultHtml, 'error');
                    break;
                case -2:
                    resultHtml += `<br><strong>éªŒè¯çŠ¶æ€:</strong> âš  è§£ç»‘é—´éš”ä¸è¶³`;
                    showResult(resultHtml, 'warning');
                    break;
                default:
                    resultHtml += `<br><strong>éªŒè¯çŠ¶æ€:</strong> ? æœªçŸ¥çŠ¶æ€ (${code})`;
                    showResult(resultHtml, 'warning');
            }
        }
        
        // è§£ç»‘å¡å¯†
        async function unbindCard() {
            if (!currentCardKey) {
                showResult('é”™è¯¯: æ²¡æœ‰å¯è§£ç»‘çš„å¡å¯†', 'error');
                return;
            }
            
            addLog('INFO', `å¼€å§‹è§£ç»‘å¡å¯†: ${currentCardKey}`);
            addDebugInfo(`å¼€å§‹è§£ç»‘å¡å¯†: ${currentCardKey}`);
            
            // ç¦ç”¨è§£ç»‘æŒ‰é’®
            document.getElementById('unbindBtn').disabled = true;
            document.getElementById('unbindBtn').innerHTML = '<div class="loading"></div> è§£ç»‘ä¸­...';
            
            showResult('æ­£åœ¨å¤„ç†è§£ç»‘å¡å¯†...', 'info');
            
            const apiEndpoint = "https://llua.cn/ajax.php";
            const sessionCookie = document.getElementById('sessionCookie').value;
            
            try {
                const unbindUrl = `${apiEndpoint}?act=kmdismissset&id=39145`;
                
                const response = await makeWeiyanRequest(unbindUrl, currentCardKey, sessionCookie);
                
                // è§£æè§£ç»‘ç»“æœ
                const unbindCode = response.code;
                const unbindMsg = response.msg;
                
                // æ˜¾ç¤ºè§£ç»‘ç»“æœ
                switch (unbindCode) {
                    case 0:
                        showResult(`è§£ç»‘æˆåŠŸ: ${unbindMsg}`, 'success');
                        addLog('SUCCESS', `å¡å¯† ${currentCardKey} è§£ç»‘æˆåŠŸ: ${unbindMsg}`);
                        document.getElementById('unbindArea').style.display = 'none';
                        break;
                    case -2:
                        showResult(`è§£ç»‘é—´éš”ä¸è¶³: ${unbindMsg}`, 'warning');
                        addLog('WARNING', `å¡å¯† ${currentCardKey} è§£ç»‘é—´éš”ä¸è¶³: ${unbindMsg}`);
                        
                        // æ˜¾ç¤ºå€’è®¡æ—¶
                        if (response.endtime) {
                            startUnbindCountdown(response.endtime);
                        }
                        break;
                    case -1:
                        if (unbindMsg && (unbindMsg.includes('æœªç»‘å®š') || unbindMsg.includes('æ— éœ€è§£ç»‘'))) {
                            showResult(`æ— éœ€è§£ç»‘: ${unbindMsg}`, 'success');
                            addLog('INFO', `å¡å¯† ${currentCardKey} æ— éœ€è§£ç»‘: ${unbindMsg}`);
                            document.getElementById('unbindArea').style.display = 'none';
                        } else {
                            showResult(`è§£ç»‘å¤±è´¥: ${unbindMsg}`, 'error');
                            addLog('ERROR', `å¡å¯† ${currentCardKey} è§£ç»‘å¤±è´¥: ${unbindMsg}`);
                            document.getElementById('unbindBtn').disabled = false;
                            document.getElementById('unbindBtn').textContent = 'è§£ç»‘å¡å¯†';
                        }
                        break;
                    default:
                        showResult(`è§£ç»‘å¤±è´¥ (ä»£ç  ${unbindCode}): ${unbindMsg}`, 'error');
                        addLog('ERROR', `å¡å¯† ${currentCardKey} è§£ç»‘å¤±è´¥ (ä»£ç  ${unbindCode}): ${unbindMsg}`);
                        document.getElementById('unbindBtn').disabled = false;
                        document.getElementById('unbindBtn').textContent = 'è§£ç»‘å¡å¯†';
                }
                
            } catch (error) {
                showResult(`è§£ç»‘è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
                addLog('ERROR', `è§£ç»‘è¯·æ±‚å¤±è´¥: ${error.message}`);
                document.getElementById('unbindBtn').disabled = false;
                document.getElementById('unbindBtn').textContent = 'è§£ç»‘å¡å¯†';
            }
        }
        
        // å¼€å§‹è§£ç»‘å€’è®¡æ—¶
        function startUnbindCountdown(seconds) {
            document.getElementById('countdownArea').style.display = 'block';
            document.getElementById('unbindBtn').disabled = true;
            document.getElementById('unbindBtn').textContent = 'ç­‰å¾…è§£ç»‘å†·å´';
            
            let remainingTime = seconds;
            
            // æ¸…é™¤ä¹‹å‰çš„å€’è®¡æ—¶
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            
            // æ›´æ–°å€’è®¡æ—¶æ˜¾ç¤º
            function updateCountdown() {
                const hours = Math.floor(remainingTime / 3600);
                const minutes = Math.floor((remainingTime % 3600) / 60);
                const secs = remainingTime % 60;
                
                document.getElementById('countdownArea').innerHTML = 
                    `è§£ç»‘å†·å´æ—¶é—´: ${hours}å°æ—¶ ${minutes}åˆ†é’Ÿ ${secs}ç§’`;
                
                remainingTime--;
                
                if (remainingTime < 0) {
                    clearInterval(countdownInterval);
                    document.getElementById('countdownArea').style.display = 'none';
                    document.getElementById('unbindBtn').disabled = false;
                    document.getElementById('unbindBtn').textContent = 'è§£ç»‘å¡å¯†';
                    showResult('è§£ç»‘å†·å´æ—¶é—´å·²ç»“æŸï¼Œå¯ä»¥é‡æ–°å°è¯•è§£ç»‘', 'info');
                }
            }
            
            // ç«‹å³æ›´æ–°ä¸€æ¬¡
            updateCountdown();
            
            // æ¯ç§’æ›´æ–°ä¸€æ¬¡
            countdownInterval = setInterval(updateCountdown, 1000);
        }
        
        // æµ‹è¯•æœ¬åœ°è¯·æ±‚ï¼ˆç»•è¿‡CORSï¼‰
        function testLocalRequest() {
            const cardKey = document.getElementById('cardKey').value;
            if (!cardKey) {
                showResult('é”™è¯¯: è¯·å…ˆè¾“å…¥å¡å¯†', 'error');
                return;
            }
            
            showResult('æ­£åœ¨å°è¯•æœ¬åœ°è¯·æ±‚æ–¹å¼...', 'info');
            addLog('INFO', 'å¼€å§‹æµ‹è¯•æœ¬åœ°è¯·æ±‚');
            
            // åˆ›å»ºä¸€ä¸ªéšè—çš„iframeæ¥å‘é€è¯·æ±‚
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.src = `https://llua.cn/?mod=cardcheck&id=39145&kami=${encodeURIComponent(cardKey)}`;
            
            iframe.onload = function() {
                showResult('æœ¬åœ°è¯·æ±‚å·²å‘é€ï¼Œä½†æ— æ³•ç›´æ¥è·å–å“åº”ã€‚<br>å»ºè®®ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•:<br>1. å®‰è£…CORSè§£é™¤æµè§ˆå™¨æ‰©å±•<br>2. ä½¿ç”¨ä»£ç†æœåŠ¡å™¨', 'info');
                addLog('INFO', 'æœ¬åœ°è¯·æ±‚å®Œæˆ');
                document.body.removeChild(iframe);
            };
            
            document.body.appendChild(iframe);
        }
        
        // æ˜¾ç¤ºç»“æœ
        function showResult(message, type) {
            const resultArea = document.getElementById('resultArea');
            resultArea.innerHTML = message;
            resultArea.className = 'result-area';
            
            if (type) {
                resultArea.classList.add(`result-${type}`);
            }
        }
        
        // æ·»åŠ æ—¥å¿—
        function addLog(level, message) {
            const timestamp = new Date().toLocaleTimeString('zh-CN', { hour12: false });
            const logEntry = {
                timestamp,
                level,
                message
            };
            
            logs.push(logEntry);
            
            // æ›´æ–°æ—¥å¿—æ˜¾ç¤º
            updateLogDisplay();
        }
        
        // æ›´æ–°æ—¥å¿—æ˜¾ç¤º
        function updateLogDisplay() {
            const logArea = document.getElementById('logArea');
            let logHtml = '';
            
            logs.slice(-20).forEach(log => {
                logHtml += `<div class="log-entry">
                    <span class="log-time">[${log.timestamp}]</span>
                    <span class="log-level-${log.level.toLowerCase()}">[${log.level}]</span>
                    ${log.message}
                </div>`;
            });
            
            logArea.innerHTML = logHtml;
            logArea.scrollTop = logArea.scrollHeight;
        }
        
        // æ·»åŠ è°ƒè¯•ä¿¡æ¯
        function addDebugInfo(message) {
            if (!debugMode) return;
            
            const debugContent = document.getElementById('debugContent');
            const timestamp = new Date().toLocaleTimeString('zh-CN', { hour12: false });
            
            debugContent.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            debugContent.scrollTop = debugContent.scrollHeight;
        }
        
        // æ¸…ç©ºè°ƒè¯•ä¿¡æ¯
        function clearDebug() {
            document.getElementById('debugContent').innerHTML = '';
        }
        
        // åˆ‡æ¢è‡ªåŠ¨ä¿®å¤
        function toggleAutoRepair() {
            autoRepairEnabled = !autoRepairEnabled;
            const button = document.querySelector('.debug-controls button:nth-child(2)');
            button.textContent = `è‡ªåŠ¨ä¿®å¤: ${autoRepairEnabled ? 'å¼€' : 'å…³'}`;
            
            addDebugInfo(`è‡ªåŠ¨ä¿®å¤ ${autoRepairEnabled ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨'}`);
            addLog('INFO', `è‡ªåŠ¨ä¿®å¤ ${autoRepairEnabled ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨'}`);
        }
        
        // å¯¼å‡ºæ—¥å¿—
        function exportLogs() {
            const logText = logs.map(log => `[${log.timestamp}] [${log.level}] ${log.message}`).join('\n');
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `card_verify_${new Date().toISOString().replace(/[:.]/g, '-')}.log`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            URL.revokeObjectURL(url);
            
            addDebugInfo('æ—¥å¿—å·²å¯¼å‡º');
            addLog('INFO', 'æ—¥å¿—å·²å¯¼å‡º');
        }
        
        // åˆ‡æ¢æ—¥å¿—æ˜¾ç¤º
        function toggleLogs() {
            const logArea = document.getElementById('logArea');
            logArea.style.display = logArea.style.display === 'none' ? 'block' : 'none';
        }
        
        // æ¸…ç©ºè¾“å…¥
        function clearInputs() {
            document.getElementById('cardKey').value = '';
            document.getElementById('sessionCookie').value = '';
            document.getElementById('resultArea').innerHTML = '';
            document.getElementById('resultArea').className = 'result-area';
            document.getElementById('unbindArea').style.display = 'none';
            
            // æ¸…é™¤å€’è®¡æ—¶
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
        }
        
        // é“¾æ¥è½¬æ¢åŠŸèƒ½
        function analyzeAndConvert() {
            const originalLink = document.getElementById('originalLink').value;
            
            if (!originalLink) {
                document.getElementById('parseInfo').innerHTML = 'é”™è¯¯: è¯·è¾“å…¥é“¾æ¥';
                document.getElementById('parseInfo').className = 'result-area result-error';
                return;
            }
            
            addDebugInfo(`åˆ†æé“¾æ¥: ${originalLink}`);
            
            // æ¨¡æ‹Ÿé“¾æ¥åˆ†æ
            setTimeout(() => {
                let convertedLink = '';
                let parseInfo = '';
                
                if (originalLink.includes('cardcheck')) {
                    // å‡è®¾è¿™æ˜¯å¦ä¸€ç§å¡å¯†éªŒè¯é“¾æ¥æ ¼å¼
                    convertedLink = originalLink.replace('cardcheck', 'ajax.php?act=inspect');
                    parseInfo = 'æ£€æµ‹åˆ°å¡å¯†éªŒè¯é“¾æ¥ï¼Œå·²è½¬æ¢ä¸ºAPIç«¯ç‚¹æ ¼å¼';
                } else if (originalLink.includes('ajax.php')) {
                    // å‡è®¾è¿™æ˜¯APIç«¯ç‚¹æ ¼å¼
                    convertedLink = originalLink;
                    parseInfo = 'æ£€æµ‹åˆ°APIç«¯ç‚¹æ ¼å¼ï¼Œæ— éœ€è½¬æ¢';
                } else {
                    // æœªçŸ¥æ ¼å¼ï¼Œå°è¯•è½¬æ¢
                    convertedLink = `https://llua.cn/ajax.php?${originalLink.split('?')[1] || 'act=inspect&app=39145'}`;
                    parseInfo = 'æœªçŸ¥é“¾æ¥æ ¼å¼ï¼Œå°è¯•è½¬æ¢ä¸ºæ ‡å‡†APIç«¯ç‚¹';
                }
                
                document.getElementById('convertedLink').value = convertedLink;
                document.getElementById('parseInfo').innerHTML = parseInfo;
                document.getElementById('parseInfo').className = 'result-area result-info';
                
                addDebugInfo(`é“¾æ¥è½¬æ¢å®Œæˆ: ${convertedLink}`);
                addLog('INFO', `é“¾æ¥è½¬æ¢: ${originalLink} -> ${convertedLink}`);
            }, 1000);
        }
        
        // ä½¿ç”¨è½¬æ¢åçš„é“¾æ¥
        function useConvertedLink() {
            const convertedLink = document.getElementById('convertedLink').value;
            if (convertedLink) {
                document.getElementById('apiEndpoint').value = convertedLink;
                
                // åˆ‡æ¢åˆ°éªŒè¯æ ‡ç­¾é¡µ
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                document.querySelector('.tab[data-tab="verify"]').classList.add('active');
                document.getElementById('verify-tab').classList.add('active');
                
                addLog('INFO', `å·²åº”ç”¨è½¬æ¢åçš„é“¾æ¥: ${convertedLink}`);
            }
        }
        
        // å¤åˆ¶è½¬æ¢åçš„é“¾æ¥
        function copyConvertedLink() {
            const convertedLink = document.getElementById('convertedLink').value;
            if (convertedLink) {
                navigator.clipboard.writeText(convertedLink).then(() => {
                    alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                    addLog('INFO', `å·²å¤åˆ¶é“¾æ¥: ${convertedLink}`);
                });
            }
        }
        
        // æ‰§è¡Œè‡ªå®šä¹‰ä»£ç 
        function executeCustomCode() {
            const customCode = document.getElementById('customCode').value;
            const resultArea = document.getElementById('customCodeResult');
            
            if (!customCode.trim()) {
                resultArea.innerHTML = 'é”™è¯¯: è¯·è¾“å…¥è‡ªå®šä¹‰ä»£ç ';
                resultArea.className = 'result-area result-error';
                return;
            }
            
            try {
                // åˆ›å»ºæ‰§è¡Œç¯å¢ƒ
                const cardKey = document.getElementById('cardKey').value;
                const apiEndpoint = document.getElementById('apiEndpoint').value;
                const sessionCookie = document.getElementById('sessionCookie').value;
                
                // ä½¿ç”¨Functionæ„é€ å‡½æ•°æ‰§è¡Œä»£ç ï¼Œé¿å…ä½¿ç”¨eval
                const func = new Function('cardKey', 'apiEndpoint', 'sessionCookie', 'addLog', 'addDebugInfo', customCode);
                const result = func(cardKey, apiEndpoint, sessionCookie, addLog, addDebugInfo);
                
                resultArea.innerHTML = `ä»£ç æ‰§è¡ŒæˆåŠŸ: ${result || 'æ— è¿”å›å€¼'}`;
                resultArea.className = 'result-area result-success';
                
                addLog('INFO', 'è‡ªå®šä¹‰ä»£ç æ‰§è¡ŒæˆåŠŸ');
                addDebugInfo('è‡ªå®šä¹‰ä»£ç æ‰§è¡ŒæˆåŠŸ');
            } catch (error) {
                resultArea.innerHTML = `ä»£ç æ‰§è¡Œé”™è¯¯: ${error.message}`;
                resultArea.className = 'result-area result-error';
                
                addLog('ERROR', `è‡ªå®šä¹‰ä»£ç æ‰§è¡Œé”™è¯¯: ${error.message}`);
                addDebugInfo(`è‡ªå®šä¹‰ä»£ç æ‰§è¡Œé”™è¯¯: ${error.message}`);
            }
        }
        
        // ä¿å­˜è‡ªå®šä¹‰ä»£ç 
        function saveCustomCode() {
            const customCode = document.getElementById('customCode').value;
            const name = prompt('è¯·è¾“å…¥ä»£ç åç§°:');
            
            if (name) {
                customCodeStorage[name] = customCode;
                localStorage.setItem('customCodeStorage', JSON.stringify(customCodeStorage));
                
                addLog('INFO', `è‡ªå®šä¹‰ä»£ç å·²ä¿å­˜: ${name}`);
                addDebugInfo(`è‡ªå®šä¹‰ä»£ç å·²ä¿å­˜: ${name}`);
            }
        }
        
        // åŠ è½½è‡ªå®šä¹‰ä»£ç 
        function loadCustomCode() {
            const names = Object.keys(customCodeStorage);
            
            if (names.length === 0) {
                alert('æ²¡æœ‰ä¿å­˜çš„è‡ªå®šä¹‰ä»£ç ');
                return;
            }
            
            const name = prompt(`è¯·è¾“å…¥è¦åŠ è½½çš„ä»£ç åç§°:\nå¯ç”¨ä»£ç : ${names.join(', ')}`);
            
            if (name && customCodeStorage[name]) {
                document.getElementById('customCode').value = customCodeStorage[name];
                addLog('INFO', `è‡ªå®šä¹‰ä»£ç å·²åŠ è½½: ${name}`);
                addDebugInfo(`è‡ªå®šä¹‰ä»£ç å·²åŠ è½½: ${name}`);
            } else {
                alert('ä»£ç ä¸å­˜åœ¨');
            }
        }
        
        // åŠ è½½ä¿å­˜çš„è‡ªå®šä¹‰ä»£ç 
        function loadSavedCustomCode() {
            const saved = localStorage.getItem('customCodeStorage');
            if (saved) {
                customCodeStorage = JSON.parse(saved);
            }
        }
        
        // å¯ç”¨è°ƒè¯•æ¨¡å¼
        function enableDebugMode() {
            debugMode = true;
            document.getElementById('debugStatus').className = 'status-indicator status-processing';
            addDebugInfo('è°ƒè¯•æ¨¡å¼å·²å¯ç”¨');
        }
        
        // åˆå§‹åŒ–è°ƒè¯•æ¨¡å¼
        enableDebugMode();
    </script>
</body>
</html>
